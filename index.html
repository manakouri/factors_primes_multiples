<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Factors, Primes, and Multiples Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .game-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .number-btn {
            border: 2px solid #e2e8f0; /* slate-200 */
        }
        .number-btn.selected {
            border-color: #3b82f6; /* blue-500 */
            background-color: #dbeafe; /* blue-100 */
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- Main Menu -->
        <div id="main-menu">
            <header class="text-center mb-8">
                <h1 class="text-5xl font-semibold text-cyan-600 mb-2 font-poppins">The Factors, Primes and Multiples Arena</h1>
                <p class="text-xl font-semibold text-slate-600 font-poppins">Choose a challenge to begin your training!</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="startGame('divisibility')" class="game-card bg-green-100 p-6 rounded-lg cursor-pointer border border-green-200 text-center">
                    <h2 class="text-2xl font-semibold text-green-800 mb-2 font-poppins">Divisibility Dash</h2>
                    <p class="text-green-900 text-base">Learn the rules, then test your speed in the Final Dash.</p>
                </div>
                <div onclick="startGame('prime')" class="game-card bg-yellow-100 p-6 rounded-lg cursor-pointer border border-yellow-200 text-center">
                    <h2 class="text-2xl font-semibold text-yellow-800 mb-2 font-poppins">Prime Peak</h2>
                    <p class="text-yellow-900 text-base">Identify prime numbers in a one-minute timed challenge.</p>
                </div>
                <div onclick="startGame('factors')" class="game-card bg-purple-100 p-6 rounded-lg cursor-pointer border border-purple-200 text-center">
                    <h2 class="text-2xl font-semibold text-purple-800 mb-2 font-poppins">Factor Forest</h2>
                    <p class="text-purple-900 text-base">Practice finding all the factors of a number.</p>
                </div>
                
                <!-- Centered Wrapper for LCM and HCF -->
                <div class="md:col-span-3 flex justify-center gap-6">
                    <div onclick="startGame('lcm')" class="game-card bg-red-100 p-6 rounded-lg cursor-pointer border border-red-200 text-center w-full md:w-1/3">
                        <h2 class="text-2xl font-semibold text-red-800 mb-2 font-poppins">LCM Lagoon</h2>
                        <p class="text-red-900 text-base">Practice finding the Lowest Common Multiple.</p>
                    </div>
                    <div onclick="startGame('hcf')" class="game-card bg-blue-100 p-6 rounded-lg cursor-pointer border border-blue-200 text-center w-full md:w-1/3">
                        <h2 class="text-2xl font-semibold text-blue-800 mb-2 font-poppins">HCF Heights</h2>
                        <p class="text-blue-900 text-base">Practice finding the Highest Common Factor.</p>
                    </div>
                </div>

                 <div onclick="startGame('ultimate')" class="game-card bg-gray-700 text-white p-6 rounded-lg cursor-pointer border border-gray-800 md:col-span-3 text-center">
                    <h2 class="text-2xl font-semibold text-cyan-300 mb-2 font-poppins">üèÜ Ultimate Challenge</h2>
                    <p class="text-base">Put all your skills to the test and beat your high score!</p>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <header class="flex justify-between items-center mb-6 flex-wrap">
                <button onclick="showScreen('main-menu')" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">&larr; Main Menu</button>
                <h2 id="game-title" class="text-3xl font-semibold text-center order-first w-full md:order-none md:w-auto mb-2 md:mb-0 font-poppins">Game Title</h2>
                <div class="text-lg font-semibold text-right space-x-4">
                    <span id="timer-display" class="hidden">Time: <span id="time-left">0:00</span></span>
                    <span id="highscore-display" class="hidden">High Score: <span id="highscore">0</span></span>
                    <span>Score: <span id="score">0</span></span>
                </div>
            </header>
            
            <div class="bg-white p-8 rounded-lg border border-slate-200">
                <div id="rule-description-area" class="hidden text-center mb-4 p-4 bg-slate-100 rounded-lg">
                    <h3 class="text-lg font-bold text-cyan-600">Divisibility Rule</h3>
                    <p id="rule-text" class="text-slate-700 text-base"></p>
                </div>
                <div id="question-area" class="text-center mb-6">
                    <p id="question-prompt" class="text-xl text-slate-600 mb-2">Prompt</p>
                    <p id="question" class="text-4xl font-bold text-cyan-500">Question</p>
                </div>

                <div id="answer-area" class="flex flex-wrap gap-4 justify-center items-center min-h-[80px]">
                    <!-- Answers will be dynamically inserted here -->
                </div>

                <div id="feedback-area" class="mt-6 text-center min-h-[50px]">
                    <p id="feedback-text" class="text-lg"></p>
                </div>

                <div class="mt-6 text-center">
                    <button id="submit-btn" class="btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Check Answer</button>
                    <button id="next-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-8 rounded-lg text-xl hidden">Next Question</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const gameTitle = document.getElementById('game-title');
        const scoreDisplay = document.getElementById('score');
        const highscoreDisplay = document.getElementById('highscore-display');
        const highscoreEl = document.getElementById('highscore');
        const timerDisplay = document.getElementById('timer-display');
        const timeLeftEl = document.getElementById('time-left');
        const questionPrompt = document.getElementById('question-prompt');
        const questionText = document.getElementById('question');
        const answerArea = document.getElementById('answer-area');
        const feedbackText = document.getElementById('feedback-text');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');

        // Game State
        let currentMode = '';
        let score = 0;
        let currentQuestionData = {};
        let highScores = { finalDash: 0, prime: 0, ultimate: 0 };
        let timerInterval;
        let timeLeft = 0;
        
        // --- State for Divisibility Game ---
        let completedLevels = [];
        let currentLevel = 1;
        let currentStageInLevel = 0;
        let isQuickfire = false;
        let isFinalDash = false;
        let quickfireQuestionCount = 0;


        // Game Config
        const gameModes = {
            'divisibility': { title: 'Divisibility Dash', color: 'text-green-800' },
            'prime': { title: 'Prime Peak', color: 'text-yellow-800', timed: true, duration: 60, highScoreKey: 'prime' },
            'factors': { title: 'Factor Forest', color: 'text-purple-800' },
            'lcm': { title: 'LCM Lagoon', color: 'text-red-800' },
            'hcf': { title: 'HCF Heights', color: 'text-blue-800' },
            'ultimate': { title: 'Ultimate Challenge', color: 'text-blue-800', timed: true, duration: 180, highScoreKey: 'ultimate'}
        };

        const divisibilityLevels = {
            1: { title: 'Level 1: The Basics', rules: [5, 10] },
            2: { title: 'Level 2: Even Numbers', rules: [2, 4, 8] },
            3: { title: 'Level 3: Threes & Sixes', rules: [3, 6, 9, 12] },
            4: { title: 'Level 4: Tricky Primes', rules: [7, 11] }
        };

        const divisibilityRulesText = {
            2: 'A number is divisible by 2 if its last digit is even (0, 2, 4, 6, or 8).  Eg. 346 is divisible by 2.',
            3: 'A number is divisible by 3 if the sum of its digits is divisible by 3.  Eg. 123 (1+2+3=6) is divisible by 3.',
            4: 'A number is divisible by 4 if the number formed by its last two digits is divisible by 4.  Eg. 712 is divisible by 4.',
            5: 'A number is divisible by 5 if its last digit is 0 or 5.  Eg. 985 is divisible by 5.',
            6: 'A number is divisible by 6 if it is divisible by both 2 and 3.  Eg. 114 (even, and 1+1+4=6) is divisible by 6.',
            7: 'Double the last digit and subtract it from the rest of the number. If the result is 0 or divisible by 7, the number is divisible by 7.  Eg. For 357, 35 - (7x2) = 21, which is divisible by 7.',
            8: 'A number is divisible by 8 if the number formed by its last three digits is divisible by 8.  Eg. 2168 is divisible by 8, because 168 is divisble by 8 (8x20=160 and 8x1=8).',
            9: 'A number is divisible by 9 if the sum of its digits is divisible by 9.  Eg. 2880 (2+8+8+0=18) is divisible by 9.',
            10: 'A number is divisible by 10 if its last digit is 0.  Eg. 4930 is divisible by 10.',
            11: 'Alternately subtract and add the digits. If the result is 0 or divisible by 11, the number is divisible by 11.  Eg. For 1353, 1-3+5-3=0, so it is divisible by 11.',
            12: 'A number is divisible by 12 if it is divisible by both 3 and 4.  Eg. 924 (9+2+4=15, and 24 is div by 4) is divisible by 12.'
        };
        
        // --- HELPER FUNCTIONS ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        const isPrime = num => {
            if (num <= 1) return false;
            for (let i = 2; i * i <= num; i++) {
                if (num % i === 0) return false;
            }
            return true;
        };

        const getFactors = num => {
            const factors = new Set();
            for (let i = 1; i * i <= num; i++) {
                if (num % i === 0) {
                    factors.add(i);
                    factors.add(num / i);
                }
            }
            return Array.from(factors).sort((a, b) => a - b);
        };

        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const lcm = (a, b) => (a * b) / gcd(a, b);

        // --- UI & STATE FUNCTIONS ---
        function showScreen(screenId) {
            stopTimer();
            mainMenu.classList.add('hidden');
            gameScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function startGame(mode) {
            currentMode = mode;
            score = 0;
            scoreDisplay.textContent = score;
            gameTitle.textContent = gameModes[mode].title;
            gameTitle.className = `text-3xl font-semibold ${gameModes[mode].color} text-center order-first w-full md:order-none md:w-auto mb-2 md:mb-0 font-poppins`;
            
            const modeConfig = gameModes[mode];

            if (mode === 'divisibility') {
                isFinalDash = false;
                showDivisibilityLevelSelect();
                return;
            }

            showScreen('game-screen');

            if (modeConfig.timed) {
                highscoreDisplay.classList.remove('hidden');
                highscoreEl.textContent = highScores[modeConfig.highScoreKey];
                timerDisplay.classList.remove('hidden');
                showGoScreen();
            } else {
                highscoreDisplay.classList.add('hidden');
                timerDisplay.classList.add('hidden');
                nextQuestion();
            }
        }
        
        function startFinalDash() {
            isFinalDash = true;
            currentMode = 'divisibility'; // Set mode for context, although isFinalDash takes precedence
            score = 0;
            scoreDisplay.textContent = score;
            
            gameTitle.textContent = "Final Dash";
            gameTitle.className = `text-3xl font-semibold ${gameModes['divisibility'].color} text-center order-first w-full md:order-none md:w-auto mb-2 md:mb-0 font-poppins`;

            highscoreDisplay.classList.remove('hidden');
            highscoreEl.textContent = highScores.finalDash;
            
            showScreen('game-screen');
            showGoScreen();
        }

        function nextQuestion() {
            feedbackText.textContent = '';
            feedbackText.className = 'text-lg';
            submitBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            answerArea.innerHTML = '';
            document.getElementById('rule-description-area').classList.add('hidden');

            if(currentMode === 'divisibility' && !isFinalDash && isQuickfire && quickfireQuestionCount === 0){
                handleLevelComplete();
                return;
            }
            
            switch (currentMode) {
                case 'divisibility': generateDivisibilityQuestion(); break;
                case 'prime': generatePrimeQuestion(); break;
                case 'factors': generateFactorsQuestion(); break;
                case 'lcm': generateLcmQuestion(); break;
                case 'hcf': generateHcfQuestion(); break;
                case 'ultimate': generateUltimateQuestion(); break;
            }
        }
        
        // --- TIMER AND SCORE FUNCTIONS ---
        
        function loadHighScores() {
            const savedScores = JSON.parse(localStorage.getItem('numberNavigatorHighScores'));
            if (savedScores) {
                highScores = savedScores;
            }
        }

        function updateHighScore() {
            let key;
            if (isFinalDash) key = 'finalDash';
            else if (gameModes[currentMode]?.highScoreKey) key = gameModes[currentMode].highScoreKey;
            
            if (key && score > highScores[key]) {
                highScores[key] = score;
                localStorage.setItem('numberNavigatorHighScores', JSON.stringify(highScores));
                highscoreEl.textContent = highScores[key];
            }
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function startTimer(duration) {
            timeLeft = duration;
            timeLeftEl.textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                timeLeftEl.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    stopTimer();
                    handleGameOver();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function handleGameOver() {
            stopTimer();
            updateHighScore();
            
            questionPrompt.textContent = "Time's Up!";
            questionText.textContent = "üèÅ";
            feedbackText.textContent = `You scored ${score}! The high score is ${highScores[isFinalDash ? 'finalDash' : gameModes[currentMode].highScoreKey]}.`;
            feedbackText.className = 'text-lg text-cyan-600 font-bold';
            answerArea.innerHTML = '';
            submitBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');

            const playAgainBtn = document.createElement('button');
            playAgainBtn.textContent = 'Play Again';
            playAgainBtn.className = 'btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg text-xl';
            if (isFinalDash) {
                playAgainBtn.onclick = startFinalDash;
            } else {
                playAgainBtn.onclick = () => startGame(currentMode);
            }

            const menuBtn = document.createElement('button');
            menuBtn.textContent = 'Main Menu';
            menuBtn.className = 'btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-8 rounded-lg text-xl';
            menuBtn.onclick = () => showScreen('main-menu');
            
            answerArea.append(playAgainBtn, menuBtn);
        }

        function showGoScreen() {
            feedbackText.textContent = '';
            answerArea.innerHTML = '';
            submitBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            document.getElementById('rule-description-area').classList.add('hidden');

            let duration;
            if (isFinalDash) {
                duration = 120;
                questionPrompt.textContent = "Ready for the Final Dash?";
                questionText.textContent = "2 Minute Challenge";
            } else {
                const modeConfig = gameModes[currentMode];
                duration = modeConfig.duration;
                questionPrompt.textContent = `Ready for ${modeConfig.title}?`;
                questionText.textContent = `${duration / 60} Minute Challenge`;
            }
            
            timeLeft = duration;
            timeLeftEl.textContent = formatTime(timeLeft);

            const goBtn = document.createElement('button');
            goBtn.textContent = 'Go!';
            goBtn.className = 'btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 px-12 rounded-lg text-3xl';
            goBtn.onclick = beginTimedChallenge;
            answerArea.appendChild(goBtn);
        }

        function beginTimedChallenge() {
            let duration;
            if (isFinalDash) {
                duration = 120;
            } else {
                duration = gameModes[currentMode].duration;
            }
            startTimer(duration);
            nextQuestion();
        }

        // --- QUESTION GENERATORS ---

        function generateUltimateQuestion() {
            const gameTypes = ['divisibility', 'prime', 'factors', 'lcm', 'hcf'];
            const randomGame = gameTypes[getRandomInt(0, gameTypes.length - 1)];

            switch(randomGame) {
                case 'divisibility': generateDivisibilityQuestion(true); break; // Pass true to indicate it's part of ultimate challenge
                case 'prime': generatePrimeQuestion(); break;
                case 'factors': generateFactorsQuestion(); break;
                case 'lcm': generateLcmQuestion(false); break; // scaffolding disabled
                case 'hcf': generateHcfQuestion(false); break; // scaffolding disabled
            }
        }
        
        function generateDivisibilityQuestion(isUltimate = false) {
            let divisor;
            const ruleArea = document.getElementById('rule-description-area');
            const ruleTextEl = document.getElementById('rule-text');

            if (isFinalDash || isUltimate) {
                const allRules = Object.keys(divisibilityRulesText);
                divisor = parseInt(allRules[getRandomInt(0, allRules.length-1)]);
                 if(isFinalDash) questionPrompt.textContent = `Final Dash | Divisible by`;
                 else questionPrompt.textContent = `Ultimate Challenge | Divisible by`;
                ruleArea.classList.add('hidden');
            } else if (isQuickfire) {
                const rulesInLevel = divisibilityLevels[currentLevel].rules;
                divisor = rulesInLevel[getRandomInt(0, rulesInLevel.length - 1)];
                questionPrompt.textContent = `Quickfire! (${quickfireQuestionCount} left) | Divisible by`;
                ruleArea.classList.add('hidden');
            } else {
                divisor = divisibilityLevels[currentLevel].rules[currentStageInLevel];
                questionPrompt.textContent = `Stage ${currentStageInLevel + 1} of ${divisibilityLevels[currentLevel].rules.length} | Divisible by`;
                ruleTextEl.textContent = divisibilityRulesText[divisor];
                ruleArea.classList.remove('hidden');
            }

            questionText.textContent = divisor;
            
            const numbers = new Set();
            const correctAnswers = [];
            while(numbers.size < 6) {
                const num = getRandomInt(10, 200);
                if (num % divisor === 0) correctAnswers.push(num);
                numbers.add(num);
            }
            while(correctAnswers.length < 2){
                const multiplier = getRandomInt(5, 20);
                const newCorrect = divisor * multiplier;
                if(!numbers.has(newCorrect)) {
                   numbers.add(newCorrect);
                   correctAnswers.push(newCorrect);
                }
            }
            currentQuestionData = { type: 'divisibility', answer: correctAnswers.sort((a, b) => a - b) };
            
            Array.from(numbers).sort((a,b) => a-b).forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'number-btn btn bg-white hover:bg-slate-100 text-slate-800 text-2xl font-bold py-3 px-6 rounded-lg';
                btn.textContent = num;
                btn.onclick = () => btn.classList.toggle('selected');
                answerArea.appendChild(btn);
            });
        }

        function generatePrimeQuestion() {
            const num = getRandomInt(2, 100);
            questionPrompt.textContent = 'Is this number prime or composite?';
            questionText.textContent = num;
            currentQuestionData = { type: 'prime', number: num, answer: isPrime(num) };
            
            const primeBtn = document.createElement('button');
            primeBtn.className = 'btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 text-2xl font-bold py-3 px-8 rounded-lg';
            primeBtn.textContent = 'Prime';
            primeBtn.onclick = () => checkAnswer(true);

            const compositeBtn = document.createElement('button');
            compositeBtn.className = 'btn bg-yellow-200 hover:bg-yellow-300 text-yellow-900 text-2xl font-bold py-3 px-8 rounded-lg';
            compositeBtn.textContent = 'Composite';
            compositeBtn.onclick = () => checkAnswer(false);
            
            answerArea.append(primeBtn, compositeBtn);
            submitBtn.classList.add('hidden');
        }
        
        function generateFactorsQuestion() {
            let num;
            do {
                num = getRandomInt(12, 100);
            } while (isPrime(num));

            questionPrompt.textContent = 'Select all the factors of';
            questionText.textContent = num;
            const factors = getFactors(num);
            currentQuestionData = { type: 'factors', answer: factors };
            
            const options = new Set(factors);
            while(options.size < 10) {
                const wrongFactor = getRandomInt(2, num - 1);
                if (num % wrongFactor !== 0) options.add(wrongFactor);
            }

            Array.from(options).sort((a,b) => a-b).forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'number-btn btn bg-white hover:bg-slate-100 text-slate-800 text-2xl font-bold py-3 px-6 rounded-lg';
                btn.textContent = n;
                btn.onclick = () => btn.classList.toggle('selected');
                answerArea.appendChild(btn);
            });
        }

        function generateLcmQuestion(scaffoldingEnabled = true) {
            const num1 = getRandomInt(4, 12);
            let num2 = getRandomInt(4, 12);
            while (num1 === num2) { num2 = getRandomInt(4, 12); }
            questionPrompt.textContent = 'What is the Lowest Common Multiple (LCM) of';
            questionText.textContent = `${num1} and ${num2}`;
            currentQuestionData = { type: 'lcm', answer: lcm(num1, num2) };

            if (scaffoldingEnabled) {
                const scaffoldContainer = document.createElement('div');
                scaffoldContainer.className = 'w-full mb-6 flex flex-col items-center';
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = 'Optional: Show Multiples Helper';
                toggleBtn.className = 'btn bg-slate-200 hover:bg-slate-300 text-sm py-2 px-4 rounded-lg mb-4';
                scaffoldContainer.appendChild(toggleBtn);
                const helperGrid = document.createElement('div');
                helperGrid.className = 'hidden w-full p-4 bg-slate-100 rounded-lg';
                scaffoldContainer.appendChild(helperGrid);
                answerArea.appendChild(scaffoldContainer);
                toggleBtn.onclick = () => {
                    helperGrid.classList.toggle('hidden');
                    if (!helperGrid.classList.contains('hidden') && helperGrid.innerHTML === '') {
                        const numbers = [num1, num2];
                        const colors = ['bg-red-300', 'bg-blue-300'];
                        const combinedColor = 'bg-purple-300';
                        let activeNumberIndex = 0;

                        const selectionDiv = document.createElement('div');
                        selectionDiv.className = 'flex justify-center gap-4 mb-4';
                        
                        const numberButtons = numbers.map((num, index) => {
                            const btn = document.createElement('button');
                            btn.textContent = `Highlight Multiples of ${num}`;
                            btn.className = `btn py-2 px-4 rounded-lg border-2`;
                            btn.onclick = () => {
                                activeNumberIndex = index;
                                updateBtnAppearance();
                            };
                            selectionDiv.appendChild(btn);
                            return btn;
                        });

                        function updateBtnAppearance() {
                            numberButtons.forEach((btn, index) => {
                                btn.classList.toggle('border-slate-800', index === activeNumberIndex);
                                btn.classList.toggle('border-transparent', index !== activeNumberIndex);
                                btn.classList.toggle(colors[index], index === activeNumberIndex);
                            });
                        }
                        updateBtnAppearance();
                        helperGrid.appendChild(selectionDiv);

                        const grid = document.createElement('div');
                        grid.className = 'grid grid-cols-10 gap-1 text-xs md:text-sm';
                        for (let i = 1; i <= 100; i++) {
                            const cell = document.createElement('div');
                            cell.textContent = i;
                            cell.className = 'p-1 text-center rounded cursor-pointer bg-white hover:bg-slate-200 aspect-square flex items-center justify-center';
                            cell.onclick = () => {
                                const colorToToggle = colors[activeNumberIndex];
                                const otherColor = colors[1 - activeNumberIndex];
                                const hadOtherColor = cell.classList.contains(otherColor);

                                cell.classList.toggle(colorToToggle);
                                
                                if (cell.classList.contains(colorToToggle) && hadOtherColor) {
                                    cell.classList.remove(otherColor);
                                    cell.classList.add(combinedColor);
                                } else if (!cell.classList.contains(colorToToggle) && cell.classList.contains(combinedColor)) {
                                     cell.classList.remove(combinedColor);
                                     cell.classList.add(otherColor);
                                }
                            };
                            grid.appendChild(cell);
                        }
                        helperGrid.appendChild(grid);
                    }
                };
            }

            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'lcm-hcf-input';
            input.className = 'bg-white text-slate-800 text-3xl text-center font-bold w-40 p-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-cyan-500';
            answerArea.appendChild(input);
        }

        function generateHcfQuestion(scaffoldingEnabled = true) {
            const useThreeNumbers = Math.random() > 0.6;
            let num1, num2, num3;
            let commonFactor;
            do {
                commonFactor = getRandomInt(3, 12);
            } while (isPrime(commonFactor));
            
            const multipliers = new Set();
            while(multipliers.size < 3) {
                const multi = getRandomInt(2, 6);
                multipliers.add(multi);
            }
            const multiArray = Array.from(multipliers);
            
            num1 = commonFactor * multiArray[0];
            num2 = commonFactor * multiArray[1];
            const numbers = [num1, num2];
            
            if(useThreeNumbers) {
                num3 = commonFactor * multiArray[2];
                numbers.push(num3);
                questionPrompt.textContent = 'What is the Highest Common Factor (HCF) of';
                questionText.textContent = `${num1}, ${num2}, and ${num3}`;
                currentQuestionData = { type: 'hcf', answer: gcd(gcd(num1, num2), num3) };
            } else {
                questionPrompt.textContent = 'What is the Highest Common Factor (HCF) of';
                questionText.textContent = `${num1} and ${num2}`;
                currentQuestionData = { type: 'hcf', answer: gcd(num1, num2) };
            }

            if (scaffoldingEnabled) {
                 const scaffoldContainer = document.createElement('div');
                scaffoldContainer.className = 'w-full mb-6 flex flex-col items-center';
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = 'Optional: Show Factors Helper';
                toggleBtn.className = 'btn bg-slate-200 hover:bg-slate-300 text-sm py-2 px-4 rounded-lg mb-4';
                scaffoldContainer.appendChild(toggleBtn);
                const helperGrid = document.createElement('div');
                helperGrid.className = 'hidden w-full p-4 bg-slate-100 rounded-lg';
                scaffoldContainer.appendChild(helperGrid);
                answerArea.appendChild(scaffoldContainer);
                toggleBtn.onclick = () => {
                     helperGrid.classList.toggle('hidden');
                    if (!helperGrid.classList.contains('hidden') && helperGrid.innerHTML === '') {
                        const colors = ['bg-blue-300', 'bg-yellow-300', 'bg-green-300'];
                        const combinedColor = 'bg-purple-300';
                        let activeNumberIndex = 0;

                        const selectionDiv = document.createElement('div');
                        selectionDiv.className = 'flex justify-center flex-wrap gap-4 mb-4';
                        
                        const numberButtons = numbers.map((num, index) => {
                            const btn = document.createElement('button');
                            btn.textContent = `Highlight Factors of ${num}`;
                            btn.className = `btn py-2 px-4 rounded-lg border-2`;
                            btn.onclick = () => {
                                activeNumberIndex = index;
                                updateBtnAppearance();
                            };
                            selectionDiv.appendChild(btn);
                            return btn;
                        });

                        function updateBtnAppearance() {
                             numberButtons.forEach((btn, index) => {
                                btn.classList.toggle('border-slate-800', index === activeNumberIndex);
                                btn.classList.toggle('border-transparent', index !== activeNumberIndex);
                                btn.classList.toggle(colors[index], index === activeNumberIndex);
                            });
                        }
                        updateBtnAppearance();
                        helperGrid.appendChild(selectionDiv);

                        const grid = document.createElement('div');
                        grid.className = 'grid grid-cols-10 gap-1 text-xs md:text-sm';
                        const maxNum = Math.max(...numbers);

                        for (let i = 1; i <= maxNum; i++) {
                            const cell = document.createElement('div');
                            cell.textContent = i;
                            cell.className = 'p-1 text-center rounded cursor-pointer bg-white hover:bg-slate-200 aspect-square flex items-center justify-center';
                            cell.onclick = () => {
                                const colorClass = colors[activeNumberIndex];
                                cell.classList.toggle(colorClass);

                                let commonCount = 0;
                                for (let c = 0; c < numbers.length; c++) {
                                    if (cell.classList.contains(colors[c])) {
                                        commonCount++;
                                    }
                                }
                                
                                if (commonCount === numbers.length) {
                                     cell.classList.add(combinedColor);
                                } else {
                                     cell.classList.remove(combinedColor);
                                }
                            };
                            grid.appendChild(cell);
                        }
                        helperGrid.appendChild(grid);
                    }
                };
            }

            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'lcm-hcf-input';
            input.className = 'bg-white text-slate-800 text-3xl text-center font-bold w-40 p-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-cyan-500';
            answerArea.appendChild(input);
        }

        function generateHcfQuestion(scaffoldingEnabled = true) {
            const useThreeNumbers = Math.random() > 0.6;
            let num1, num2, num3;
            const commonFactor = getRandomInt(3, 12);
            const multipliers = [];
            while(multipliers.length < 3) {
                const multi = getRandomInt(2, 6);
                if(!multipliers.includes(multi)) multipliers.push(multi);
            }
            num1 = commonFactor * multipliers[0];
            num2 = commonFactor * multipliers[1];
            const numbers = [num1, num2];
            
            if(useThreeNumbers) {
                num3 = commonFactor * multipliers[2];
                numbers.push(num3);
                questionPrompt.textContent = 'What is the Highest Common Factor (HCF) of';
                questionText.textContent = `${num1}, ${num2}, and ${num3}`;
                currentQuestionData = { type: 'hcf', answer: gcd(gcd(num1, num2), num3) };
            } else {
                questionPrompt.textContent = 'What is the Highest Common Factor (HCF) of';
                questionText.textContent = `${num1} and ${num2}`;
                currentQuestionData = { type: 'hcf', answer: gcd(num1, num2) };
            }

            if (scaffoldingEnabled) {
                 const scaffoldContainer = document.createElement('div');
                scaffoldContainer.className = 'w-full mb-6 flex flex-col items-center';
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = 'Optional: Show Factors Helper';
                toggleBtn.className = 'btn bg-slate-200 hover:bg-slate-300 text-sm py-2 px-4 rounded-lg mb-4';
                scaffoldContainer.appendChild(toggleBtn);
                const helperGrid = document.createElement('div');
                helperGrid.className = 'hidden w-full p-4 bg-slate-100 rounded-lg';
                scaffoldContainer.appendChild(helperGrid);
                answerArea.appendChild(scaffoldContainer);
                toggleBtn.onclick = () => { /* ... scaffold logic ... */ };
            }

            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'lcm-hcf-input';
            input.className = 'bg-white text-slate-800 text-3xl text-center font-bold w-40 p-2 border-2 border-slate-300 rounded-lg focus:outline-none focus:border-cyan-500';
            answerArea.appendChild(input);
        }
        
        // --- DIVISIBILITY GAME FLOW FUNCTIONS ---

        function showDivisibilityLevelSelect() {
            currentMode = 'divisibility';
            gameTitle.textContent = gameModes['divisibility'].title;
            gameTitle.className = `text-3xl font-medium ${gameModes['divisibility'].color} text-center order-first w-full md:order-none md:w-auto mb-2 md:mb-0 font-poppins`;
            showScreen('game-screen');
            questionPrompt.textContent = 'Select a level to practice, or try the Final Dash!';
            questionText.innerHTML = '&nbsp;';
            answerArea.innerHTML = '';
            feedbackText.textContent = '';
            submitBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');
            document.getElementById('rule-description-area').classList.add('hidden');

            for (let level in divisibilityLevels) {
                const levelNum = parseInt(level);
                const btn = document.createElement('button');
                btn.className = 'btn text-xl font-bold py-4 px-6 rounded-lg w-full md:w-auto text-left border';
                btn.innerHTML = `<span class="block font-bold text-2xl font-poppins">${divisibilityLevels[level].title}</span><span class="block text-base font-normal text-slate-600">Divisibility Rules: ${divisibilityLevels[level].rules.join(', ')}</span>`;
                
                if (completedLevels.includes(levelNum)) {
                    btn.classList.add('bg-green-200', 'border-green-400', 'hover:bg-green-300');
                } else {
                    btn.classList.add('bg-white', 'hover:bg-slate-50', 'border-slate-300');
                }
                
                btn.onclick = () => startLevel(levelNum);
                answerArea.appendChild(btn);
            }
            
            const finalDashBtn = document.createElement('button');
            finalDashBtn.className = 'btn text-xl font-bold py-4 px-6 rounded-lg w-full text-center border bg-gray-700 hover:bg-gray-600 text-white border-gray-800';
            finalDashBtn.innerHTML = `<span class="block font-bold text-2xl text-cyan-300 font-poppins">Final Dash</span><span class="block text-base font-normal text-slate-300">A 2-minute timed challenge with all rules!</span>`;
            finalDashBtn.onclick = startFinalDash;
            answerArea.appendChild(finalDashBtn);
        }

        function startLevel(levelNum) {
            currentLevel = levelNum;
            currentStageInLevel = 0;
            isQuickfire = false;
            isFinalDash = false;
            quickfireQuestionCount = 0;
            score = 0;
            scoreDisplay.textContent = score;
            nextQuestion();
        }

        function handleLevelComplete() {
            questionPrompt.textContent = `Level ${currentLevel} Complete!`;
            questionText.textContent = `üéâ Well Done! üéâ`;
            answerArea.innerHTML = '';
            document.getElementById('rule-description-area').classList.add('hidden');
            feedbackText.textContent = `You've mastered all the rules for Level ${currentLevel}.`;
            feedbackText.className = 'text-lg text-green-600';
            submitBtn.classList.add('hidden');
            nextBtn.classList.add('hidden');

            if (!completedLevels.includes(currentLevel)) {
                completedLevels.push(currentLevel);
            }

            const backBtn = document.createElement('button');
            backBtn.textContent = 'Back to Level Select';
            backBtn.className = 'btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg text-xl';
            backBtn.onclick = showDivisibilityLevelSelect;
            answerArea.appendChild(backBtn);
        }

        // --- ANSWER CHECKING LOGIC ---
        function checkAnswer(userAnswer) {
            if (timeLeft <= 0 && (gameModes[currentMode]?.timed || isFinalDash)) return; // Prevent answers after time is up

            let isCorrect = false;
            let feedback = '';
            const questionType = currentMode === 'ultimate' ? currentQuestionData.type : currentMode;


            if (questionType === 'divisibility' || questionType === 'factors') {
                const selectedBtns = answerArea.querySelectorAll('.selected');
                const userAnswers = Array.from(selectedBtns).map(btn => parseInt(btn.textContent)).sort((a,b)=>a-b);
                if (JSON.stringify(userAnswers) === JSON.stringify(currentQuestionData.answer)) isCorrect = true;
                const noun = questionType === 'factors' ? 'factors' : 'answers';
                feedback = `The correct ${noun} are: ${currentQuestionData.answer.join(', ')}.`;

            } else if (questionType === 'prime') {
                if (userAnswer === currentQuestionData.answer) isCorrect = true;
                const type = currentQuestionData.answer ? 'prime' : 'composite';
                const reason = type === 'prime' 
                    ? `Its only factors are 1 and ${currentQuestionData.number}.`
                    : `Its factors are ${getFactors(currentQuestionData.number).join(', ')}.`;
                feedback = `${currentQuestionData.number} is ${type}. ${reason}`;

            } else if (questionType === 'lcm' || questionType === 'hcf') {
                const input = document.getElementById('lcm-hcf-input');
                const parsedAnswer = parseInt(input.value);
                if (parsedAnswer === currentQuestionData.answer) isCorrect = true;
                feedback = `The correct answer is ${currentQuestionData.answer}.`;
            }

            if (isCorrect) {
                score++;
                feedbackText.textContent = 'Correct!';
                feedbackText.className = 'text-lg text-green-600';
            } else {
                feedbackText.textContent = 'Not quite. ' + feedback;
                feedbackText.className = 'text-lg text-red-600';
            }
            scoreDisplay.textContent = score;

            if (currentMode === 'divisibility' && !isFinalDash) {
                if (isCorrect) {
                    if (isQuickfire) quickfireQuestionCount--;
                    else currentStageInLevel++;
                    if (!isQuickfire && currentStageInLevel >= divisibilityLevels[currentLevel].rules.length) {
                        isQuickfire = true;
                        quickfireQuestionCount = 6;
                        feedbackText.innerHTML = 'All stages complete! <br> Get ready for a quickfire round of 6 questions.';
                    }
                }
                nextBtn.textContent = isCorrect ? 'Next' : 'Try Again';
            } else {
                 nextBtn.textContent = 'Next Question';
            }

            submitBtn.classList.add('hidden');
            if(questionType !== 'prime' ) {
                nextBtn.classList.remove('hidden');
            } else {
                setTimeout(() => { if(timeLeft > 0 || !gameModes[currentMode]?.timed) nextBtn.classList.remove('hidden'); }, 800);
            }
            
            answerArea.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const input = document.getElementById('lcm-hcf-input');
            if (input) input.disabled = true;
            
            // For timed modes, automatically move to next question if correct
            if (isCorrect && (gameModes[currentMode]?.timed || isFinalDash)) {
                setTimeout(nextQuestion, 800);
            }
        }

        // Event Listeners
        window.addEventListener('load', loadHighScores);
        submitBtn.addEventListener('click', () => checkAnswer());
        nextBtn.addEventListener('click', nextQuestion);

    </script>
</body>
</html>


